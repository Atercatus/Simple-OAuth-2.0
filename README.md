# OAuth Simulation

## Role

### Client

- 기본적인 3rd-party app

### Authorization Server


### Resource Server

---

## Flow
> https://datatracker.ietf.org/doc/html/rfc6749#section-1.2
1. Authorization Request (Client => Resource Owner)
2. Authorization Grant (Resource Owner => Client)
3. Authorization Grant (Client => Authorization Server)
4. Access Token (Authorization Server => Client)
5. Access Token (Client => Resource Server)
6. Protected Resource (Resource Server => Client)

### Client Registration
- client type
- client identifier
- client authentication
  - using HTTP Authorization header [recommend]
  - req body (client_id, client_secret)
  
### Obtaining  Authorization

> we use "Authorization Code Grant"
> https://datatracker.ietf.org/doc/html/rfc6749#section-4.1
> 
![image](https://user-images.githubusercontent.com/32104982/147594738-33c63c20-81aa-40c3-93fc-8c4fea6b36bc.png)

1. Client initiate
    - client identifier
    - scope
    - local state
    - redirection URI
2. Authorization Server authenticates the resource owner (grant or denied)
3. Redirect with "authorization code" and "local state provided by the client"
4. Client requests access token from Authorization Server (using code)
5. Client request protected resource from Resource Server (using access token)

#### Authorization Request

- response_type (REQUIRED)
  - Value MUST be set to "code".
- client_id (REQUIRED)
- redirected_uri (OPTIONAL)
- scope (OPTIONAL)
- state (RECOMMENDED)
  - An opaque value user by the client to maintain state between the request and callback. 
    The authorization server includes this value when redirecting the user-agent back
    to the client. The parameter SHOULD be used for preventing cross-site request forgery.
- redirect_uri (OPTIONAL)

#### Authorization Response

- code (REQUIRED)
  - The authorization code generated by the authorization server. A maximum authorization code lifetime of 10 minutes 
   is RECOMMENDED
- state (REQUIRED)

```
 HTTP/1.1 302 Found
 Location: https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA
           &state=xyz
```

#### Access Token Request

- grant_type (REQUIRED)
  - "authorization_code"
- code (REQUIRED)
- redirect_uri (REQUIRED)
  - 왜 여기서만 REQUIRED 냐면, 이전 Authorization Grant req 에서 사용된 redirect_url 과 다른지 체크함과 동시에, 초기화 단계에서 등록된 
  client_id와 매핑된 redirect_url 과 다른지 체크한다.
  - 이를 통해서, 누군가가 코드를 가로채서 토큰을 요청하는지 알 수 있다.
  - https://security.stackexchange.com/questions/44214/what-is-the-purpose-of-oauth-2-0-redirect-uri-checking/98049#98049
  - https://stackoverflow.com/questions/37659188/why-is-redirect-uri-required-on-access-token-request
- client_id (REQUIRED)

```
POST /token HTTP/1.1
Host: server.example.com
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&code=SplxlOBeZQQYbYS6WxSbIA
&redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb
```

#### Access Token Response

> scope
> OPTIONAL, 
> if identical to the scope requested by the client
> otherwise, REQUIRED.  
> The scope of the access token as
> described by Section 3.3.


```
HTTP/1.1 200 OK
Content-Type: application/json;charset=UTF-8
Cache-Control: no-store
Pragma: no-cache

{
    "access_token":"2YotnFZFEjr1zCsicMWpAA",
    "token_type":"example",
    "expires_in":3600,
    "refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA",
    "example_parameter":"example_value"
}
 ```

### Refreshing an Access Token

- grant_type (REQUIRED)
  - "refresh_token"
- refresh_token (REQUIRED)
- scope (OPTIONAL)

```
POST /token HTTP/1.1
Host: server.example.com
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token&refresh_token=tGzv3JOkF0XG5Qx2TlKWIA
```

---

## 참고 자료

- https://developers.google.com/youtube/v3/guides/auth/server-side-web-apps?hl=ko
- https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps
- https://datatracker.ietf.org/doc/html/rfc6749
